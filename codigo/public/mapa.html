<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Problemas - Mock</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h2 {
            margin: 20px;
        }
    </style>
</head>
<body>
    <h2>Mapa de Relatos</h2>
    <div style="margin: 0 20px 10px 20px;">
        <!-- Ajuste manual do bairro: altere o valor abaixo para o ID do bairro desejado -->
        <label for="bairroId">Bairro ID:</label>
        <input id="bairroId" type="number" value="1" min="1" style="width:80px;" />
        <button id="btnCarregar">Carregar</button>
        <small style="margin-left:8px;">IDs disponíveis: 1=Savassi, 2=Funcionários, 3=Lourdes, 4=Santo Antônio</small>
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        function carregarMapaPorBairro(bairroId) {
            Promise.all([
                fetch(`/bairros/${bairroId}`).then(r => r.json()),
                fetch(`/localidades?bairroId=${bairroId}`).then(r => r.json())
            ]).then(([bairro, localidades]) => {
                const centro = bairro && bairro.lat ? [bairro.lat, bairro.lng] : [-19.9191, -43.9386];
                const map = L.map('map').setView(centro, 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                if (bairro && bairro.lat) {
                    L.circle([bairro.lat, bairro.lng], {
                        color: 'orange',
                        fillColor: '#ffa500',
                        fillOpacity: 0.3,
                        radius: bairro.raio || 800
                    }).addTo(map).bindPopup(`Bairro ${bairro.nome}`);
                }
                localidades.forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lng]).addTo(map);
                    marker.bindPopup(`<strong>${loc.titulo}</strong>`);
                });
            }).catch(err => {
                document.getElementById("map").innerHTML = "Erro ao carregar pontos do mapa.";
            });
        }

        const input = document.getElementById('bairroId');
        document.getElementById('btnCarregar').addEventListener('click', () => {
            const id = parseInt(input.value, 10) || 1;
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '';
            mapDiv.remove();
            const newDiv = document.createElement('div');
            newDiv.id = 'map';
            newDiv.style.height = '80vh';
            document.body.appendChild(newDiv);
            carregarMapaPorBairro(id);
        });

        carregarMapaPorBairro(parseInt(input.value, 10));
    </script>
</body>
</html>
